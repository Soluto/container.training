<!DOCTYPE html>
<html>
  <head>
    <title>Dockerfile And Docker Compose </title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <link rel="stylesheet" href="workshop.css">
  </head>
  <body>
    <!--
    <div style="position: absolute; left: 20%; right: 20%; top: 30%;">
      <h1 style="font-size: 3em;">Loading ...</h1>
      The slides should show up here. If they don't, it might be
      because you are accessing this file directly from your filesystem.
      It needs to be served from a web server. You can try this:
      <pre>
        docker-compose up -d
        open http://localhost:8888/workshop.html # on MacOS
        xdg-open http://localhost:8888/workshop.html # on Linux
      </pre>
      Once the slides are loaded, this notice disappears when you
      go full screen (e.g. by hitting "f").
    </div>
    -->
    <textarea id="source">class: title, self-paced

Dockerfile<br/>And<br/>Docker Compose<br/>

.nav[*Self-paced version*]

.debug[
```

```

These slides have been built from commit: 7c9181c


[shared/title.md](https://github.com/Soluto/container.training/tree/master/slides/shared/title.md)]
---

class: title, in-person

Dockerfile<br/>And<br/>Docker Compose<br/><br/></br>

.footnote[
**Be kind to the WiFi!**<br/>
<!-- *Use the 5G network.* -->
*Don't use your hotspot.*<br/>
*Don't stream videos or download big files during the workshop[.](https://www.youtube.com/watch?v=h16zyxiwDLY)*<br/>
*Thank you!*

**Slides: https://container-training.soluto.io/**
]

.debug[[shared/title.md](https://github.com/Soluto/container.training/tree/master/slides/shared/title.md)]
---
## About these slides
- The content in these slides created by JÃ©rÃ´me Petazzoni and others, maintained by Soluto.

- All the content is available in a public GitHub repository:

  https://github.com/soluto/container.training

- You can get updated "builds" of the slides there:

  https://container-training.soluto.io/

<!--
.exercise[
```open https://github.com/soluto/container.training```
```open http://container.training/```
]
-->

--

- Typos? Mistakes? Questions? Feel free to hover over the bottom of the slide ...

.footnote[.emoji[ðŸ‘‡] Try it! The source file will be shown and you can view it on GitHub and fork and edit it.]

<!--
.exercise[
```open https://github.com/soluto/container.training/tree/master/slides/common/about-slides.md```
]
-->

.debug[[shared/about-slides.md](https://github.com/Soluto/container.training/tree/master/slides/shared/about-slides.md)]
---

class: extra-details

## Extra details

- This slide has a little magnifying glass in the top left corner

- This magnifying glass indicates slides that provide extra details

- Feel free to skip them if:

  - you are in a hurry

  - you are new to this and want to avoid cognitive overload

  - you want only the most essential information

- You can review these slides another time if you want, they'll be waiting for you â˜º

.debug[[shared/about-slides.md](https://github.com/Soluto/container.training/tree/master/slides/shared/about-slides.md)]
---
## Overview

Your mission: running integration tests using docker.

Start by clonning the repo:
```
git clone https://github.com/omerlh/compose-exercise.git
```
.debug[[shared/compose-exercise.md](https://github.com/Soluto/container.training/tree/master/slides/shared/compose-exercise.md)]
---

name: toc-chapter-1

## Chapter 1

- [Building Docker images with a Dockerfile](#toc-building-docker-images-with-a-dockerfile)

- [Compose for development stacks](#toc-compose-for-development-stacks)

.debug[(auto-generated TOC)]



.debug[[shared/toc.md](https://github.com/Soluto/container.training/tree/master/slides/shared/toc.md)]
---

class: pic

.interstitial[![Image separating from the next chapter](https://gallant-turing-d0d520.netlify.com/containers/Container-Ship-Freighter-Navigation-Elbe-Romance-1782991.jpg)]

---

name: toc-building-docker-images-with-a-dockerfile
class: title

Building Docker images with a Dockerfile

.nav[
[Previous section](#toc-)
|
[Back to table of contents](#toc-chapter-1)
|
[Next section](#toc-compose-for-development-stacks)
]

.debug[(automatically generated title slide)]

---

class: title

# Building Docker images with a Dockerfile

![Construction site with containers](images/title-building-docker-images-with-a-dockerfile.jpg)

.debug[[containers/Building_Images_With_Dockerfiles.md](https://github.com/Soluto/container.training/tree/master/slides/containers/Building_Images_With_Dockerfiles.md)]
---

## Objectives

We will build a container image automatically, with a `Dockerfile`.

At the end of this lesson, you will be able to:

* Write a `Dockerfile`.

* Build an image from a `Dockerfile`.

.debug[[containers/Building_Images_With_Dockerfiles.md](https://github.com/Soluto/container.training/tree/master/slides/containers/Building_Images_With_Dockerfiles.md)]
---

## `Dockerfile` overview

* A `Dockerfile` is a build recipe for a Docker image.

* It contains a series of instructions telling Docker how an image is constructed.

* The `docker build` command builds an image from a `Dockerfile`.

.debug[[containers/Building_Images_With_Dockerfiles.md](https://github.com/Soluto/container.training/tree/master/slides/containers/Building_Images_With_Dockerfiles.md)]
---

## Writing our first `Dockerfile`

Our Dockerfile must be in a **new, empty directory**.

Create a `Dockerfile` inside this directory.

```bash
$ cd compose-exercise
$ vim Dockerfile
```

Of course, you can use any other editor of your choice.

.debug[[containers/Building_Images_With_Dockerfiles.md](https://github.com/Soluto/container.training/tree/master/slides/containers/Building_Images_With_Dockerfiles.md)]
---

## Type this into our Dockerfile...

```dockerfile
FROM node

WORKDIR /app
COPY . .
RUN yarn install
```

* `FROM` indicates the base image for our build.

* `WORKDIR` set the working directory for the rest of the commands

## The `RUN` instruction

* Each `RUN` line will be executed by Docker during the build.

* Our `RUN` commands **must be non-interactive.**
  <br/>(No input can be provided to Docker during the build.)

.debug[[containers/Building_Images_With_Dockerfiles.md](https://github.com/Soluto/container.training/tree/master/slides/containers/Building_Images_With_Dockerfiles.md)]
---

## The `COPY` instruction

The `COPY` instruction adds files and content from your host into the
image.

```dockerfile
COPY . /src
```

This will add the contents of the *build context* (the directory
passed as an argument to `docker build`) to the directory `/src`
in the container.

.debug[[containers/Building_Images_With_Dockerfiles.md](https://github.com/Soluto/container.training/tree/master/slides/containers/Building_Images_With_Dockerfiles.md)]
---

## Build it!

Save our file, then execute:

```bash
$ docker build -t api .
```

* `-t` indicates the tag to apply to the image.

* `.` indicates the location of the *build context*.

We will talk more about the build context later.

To keep things simple for now: this is the directory where our Dockerfile is located.

.debug[[containers/Building_Images_With_Dockerfiles.md](https://github.com/Soluto/container.training/tree/master/slides/containers/Building_Images_With_Dockerfiles.md)]
---

## What happens when we build the image?

The output of `docker build` looks like this:

.small[
```bash
Sending build context to Docker daemon  25.03MB
Step 1/4 : FROM node
 ---> c63e58f0a7b2
Step 2/4 : WORKDIR /app
 ---> Running in ef77b990dd3d
Removing intermediate container ef77b990dd3d
 ---> 5029fcef7d04
Step 3/4 : COPY . .
 ---> 9b7600bcc932
Step 4/4 : RUN yarn install
 ---> Running in bc1af5515cd0
yarn install v1.13.0
info No lockfile found.
[1/4] Resolving packages...
[2/4] Fetching packages...
[3/4] Linking dependencies...
[4/4] Building fresh packages...
success Saved lockfile.
Done in 0.07s.
Removing intermediate container bc1af5515cd0
 ---> 46277efee36f
Successfully built api:latest
```
]

* Let's explain what this output means.

.debug[[containers/Building_Images_With_Dockerfiles.md](https://github.com/Soluto/container.training/tree/master/slides/containers/Building_Images_With_Dockerfiles.md)]
---

## Sending the build context to Docker

```bash
Sending build context to Docker daemon  25.03MB
```

* The build context is the `.` directory given to `docker build`.

* It is sent (as an archive) by the Docker client to the Docker daemon.

* This allows to use a remote machine to build using local files.

* Be careful (or patient) if that directory is big and your link is slow.

.debug[[containers/Building_Images_With_Dockerfiles.md](https://github.com/Soluto/container.training/tree/master/slides/containers/Building_Images_With_Dockerfiles.md)]
---

## Executing each step

```bash
Step 3/4 : COPY . .
 ---> 9b7600bcc932
Step 4/4 : RUN yarn install
 ---> Running in bc1af5515cd0
(...output of the RUN command...)
Removing intermediate container bc1af5515cd0
 ---> 46277efee36f
```

* A container (`9b7600bcc932`) is created from the previous step.

* The `RUN` command is executed in this container.

* The container is committed into an image (`e01b294dbffd`).

* The build container (`9b7600bcc932`) is removed.

* The output of this step will be the base image for the next one.

.debug[[containers/Building_Images_With_Dockerfiles.md](https://github.com/Soluto/container.training/tree/master/slides/containers/Building_Images_With_Dockerfiles.md)]
---

## The caching system

If you run the same build again, it will be instantaneous. Why?

* After each build step, Docker takes a snapshot of the resulting image.

* Before executing a step, Docker checks if it has already built the same sequence.

You can force a rebuild with `docker build --no-cache ...`.

.debug[[containers/Building_Images_With_Dockerfiles.md](https://github.com/Soluto/container.training/tree/master/slides/containers/Building_Images_With_Dockerfiles.md)]
---

## More efficient images

If you make change any file, docker will run `yarn install` again. Why?
Let's look on the docker file again: 

```dockerfile
(1) FROM node

(2) WORKDIR /app
(3) COPY . .
(4) RUN yarn install
```

Take a look on line 3.

.debug[[containers/Building_Images_With_Dockerfiles.md](https://github.com/Soluto/container.training/tree/master/slides/containers/Building_Images_With_Dockerfiles.md)]
---

## Docker file - V2

```dockerfile
FROM node

WORKDIR /app
COPY package.json yarn.lock /app/
RUN yarn install
COPY . .
```

Now `yarn install` will run only if `package.json` has changed!

.debug[[containers/Building_Images_With_Dockerfiles.md](https://github.com/Soluto/container.training/tree/master/slides/containers/Building_Images_With_Dockerfiles.md)]
---

## Running the image

The resulting image is not different from the one produced manually.

```bash
$ docker run -it api
> 
```

Why nothing happened?

## The `CMD` instruction

The `CMD` instruction is a default command run when a container is
launched from the image.
Add the following line to the dockerfile:

```dockerfile
CMD ["node", "src/server.js"]
```

.debug[[containers/Building_Images_With_Dockerfiles.md](https://github.com/Soluto/container.training/tree/master/slides/containers/Building_Images_With_Dockerfiles.md)]
---

## The complete dockerfile

You're dockerfile now should look like the following:

```dockerfile
FROM node

WORKDIR /app
COPY package.json yarn.lock /app/
RUN yarn install
COPY . .
CMD ["node", "src/server.js"]
```

.debug[[containers/Building_Images_With_Dockerfiles.md](https://github.com/Soluto/container.training/tree/master/slides/containers/Building_Images_With_Dockerfiles.md)]
---

## Running the image V2

Build the updated dockerfile using:
```
docker build . -t api
```
The resulting image is not different from the one produced manually.

```bash
$ docker run -it api
Example app listening on port 5678!
```

YAY!
.debug[[containers/Building_Images_With_Dockerfiles.md](https://github.com/Soluto/container.training/tree/master/slides/containers/Building_Images_With_Dockerfiles.md)]
---

class: pic

.interstitial[![Image separating from the next chapter](https://gallant-turing-d0d520.netlify.com/containers/ShippingContainerSFBay.jpg)]

---

name: toc-compose-for-development-stacks
class: title

Compose for development stacks

.nav[
[Previous section](#toc-building-docker-images-with-a-dockerfile)
|
[Back to table of contents](#toc-chapter-1)
|
[Next section](#toc-)
]

.debug[(automatically generated title slide)]

---
# Compose for development stacks

Dockerfiles are great to build container images.

But what if we work with a complex stack made of multiple containers?

In our case - run integration tests that requires Mongo DB.

Eventually, we will want to write some custom scripts and automation to build, run, and connect
our containers together.

There is a better way: using Docker Compose.

In this section, you will use Compose to bootstrap a development environment.

.debug[[containers/Compose_For_Dev_Stacks.md](https://github.com/Soluto/container.training/tree/master/slides/containers/Compose_For_Dev_Stacks.md)]
---

## What is Docker Compose?

Docker Compose (formerly known as `fig`) is an external tool.

Unlike the Docker Engine, it is written in Python. It's open source as well.

The general idea of Compose is to enable a very simple, powerful onboarding workflow:

1. Checkout your code.

2. Run `docker-compose up`.

3. Your app is up and running!

.debug[[containers/Compose_For_Dev_Stacks.md](https://github.com/Soluto/container.training/tree/master/slides/containers/Compose_For_Dev_Stacks.md)]
---

## Compose overview

This is how you work with Compose:

* You describe a set (or stack) of containers in a YAML file called `docker-compose.yml`.

* You run `docker-compose up`.

* Compose automatically pulls images, builds containers, and starts them.

* Compose can set up links, volumes, and other Docker options for you.

* Compose can run the containers in the background, or in the foreground.

* When containers are running in the foreground, their aggregated output is shown.

.debug[[containers/Compose_For_Dev_Stacks.md](https://github.com/Soluto/container.training/tree/master/slides/containers/Compose_For_Dev_Stacks.md)]
---

## The `docker-compose.yml` file

Here is the file used in the demo:

.small[
```yaml
version: '3'

services:
  mongo:
    image: mongo
    logging:
      driver: none
  api:
    build:
      context: .
    command: ["yarn", "test"]
    environment:
      - CONNECTION_STRING=mongodb://mongo:27017
```
]

.debug[[containers/Compose_For_Dev_Stacks.md](https://github.com/Soluto/container.training/tree/master/slides/containers/Compose_For_Dev_Stacks.md)]
---

## Compose file structure

A Compose file has multiple sections:

* `version` is mandatory. (We should use `"2"` or later; version 1 is deprecated.)

* `services` is mandatory. A service is one or more replicas of the same image running as containers.

.debug[[containers/Compose_For_Dev_Stacks.md](https://github.com/Soluto/container.training/tree/master/slides/containers/Compose_For_Dev_Stacks.md)]
---

## Containers in `docker-compose.yml`

Each service in the YAML file must contain either `build`, or `image`.

* `build` indicates a path containing a Dockerfile.

* `image` indicates an image name (local, or on a registry).

* If both are specified, an image will be built from the `build` directory and named `image`.

The other parameters are optional.

They encode the parameters that you would typically add to `docker run`.

.debug[[containers/Compose_For_Dev_Stacks.md](https://github.com/Soluto/container.training/tree/master/slides/containers/Compose_For_Dev_Stacks.md)]
---

## Compose commands

To launch the stack, run:

```bash
docker-compose up --build
```

.debug[[containers/Compose_For_Dev_Stacks.md](https://github.com/Soluto/container.training/tree/master/slides/containers/Compose_For_Dev_Stacks.md)]
---

## Waiting for tests to complete

We saw how to run the tests, but how can we use that to run tests?

This is where we can use the `--exit-code-from` flag:

```bash
docker-compose up --exit-code-from api
```

.debug[[containers/Compose_For_Dev_Stacks.md](https://github.com/Soluto/container.training/tree/master/slides/containers/Compose_For_Dev_Stacks.md)]
---

## Service discovery in container-land

How does each service find out the address of the other ones?

--

- We do not hard-code IP addresses in the code

- We do not hard-code FQDN in the code, either

- We just connect to a service name, and container-magic does the rest

  (And by container-magic, we mean "a crafty, dynamic, embedded DNS server")
  
--

For example, this is how the web is connected with the DB:
```
CONNECTION_STRING=mongodb://mongo:27017
```

.debug[[containers/Compose_For_Dev_Stacks.md](https://github.com/Soluto/container.training/tree/master/slides/containers/Compose_For_Dev_Stacks.md)]
---

## A real life example

The tools we learned today are used commonly for testings.
Checkout for example [Kamus](https://github.com/Soluto/kamus) end to end tests.
[CI build example](https://circleci.com/gh/Soluto/kamus/1346)

.small[
```
version: '3'
services:
  encryptor:
    image: $ENCRYPTOR_IMAGE
    environment:
  decryptor:
    image: $DECRYPTOR_IMAGE
    environment:
      - Kubernetes__ProxyUrl=http://wiremock:8080
  black-box:
    build:
      context: ../
    environment:
      - ENCRYPTOR=http://encryptor:9999/
      - DECRYPTOR=http://decryptor:9999/
      - PROXY_URL=http://zap:8090
      - KUBERNETES_URL=http://wiremock:8080
  wiremock:
    build:
      context: ../Wiremock
```
]
.debug[[containers/Compose_For_Dev_Stacks.md](https://github.com/Soluto/container.training/tree/master/slides/containers/Compose_For_Dev_Stacks.md)]
---
class: title, self-paced

Thank you!

.debug[[shared/thankyou.md](https://github.com/Soluto/container.training/tree/master/slides/shared/thankyou.md)]
---

class: title, in-person

That's all, folks! <br/> Questions?

![end](images/end.jpg)

.debug[[shared/thankyou.md](https://github.com/Soluto/container.training/tree/master/slides/shared/thankyou.md)]
---
class: title, self-paced

We're Hiring!
.debug[[shared/hire.md](https://github.com/Soluto/container.training/tree/master/slides/shared/hire.md)]
---

class: title, in-person

Enjoyed the workshop? 
Love working with Containers? 

So do we!

Join us - Check out our [open positions](http://jobs.soluto.com)!

![end](images/soluto.jpg)

.debug[[shared/hire.md](https://github.com/Soluto/container.training/tree/master/slides/shared/hire.md)]</textarea>
    <script src="remark.min.js" type="text/javascript">
    </script>
    <script type="text/javascript">
      var slideshow = remark.create({
        ratio: '16:9',
        highlightSpans: true,
        excludedClasses: ["self-paced"]
      });
    </script>
    
    <!-- 
    These two scripts will be available only when loading the
    content using the pub/sub server. Otherwise, they'll just
    404 and that's OK.
    -->
    <script src="/socket.io/socket.io.js">
    </script>
    <script src="/remote.js">
    </script>

  </body>
</html>
